import logging

from flask import abort, Flask, request


app = Flask(__name__)


@app.route('/update/discovery')
def update_discovery():
    # This header can't be spoofed, see
    # https://cloud.google.com/appengine/docs/flexible/nodejs/scheduling-jobs-with-cron-yaml#securing_urls_for_cron
    if request.headers.get('X-AppEngine-Cron') is None:
        abort(403)

    dartman_dir = '/discovery-artifact-manager'
    cmd = 'go run src/main/updatedisco/main.go'
    subprocess.call(shlex.split(cmd), cwd=dartman_dir)

    cmd = 'git add discoveries'
    subprocess.call(shlex.split(cmd), cwd=dartman_dir)

    cmd = 'git commit -m "Autogenerated Discovery document update"'
    subprocess.call(shlex.split(cmd), cwd=dartman_dir)

    cmd = ('git remote add github '
           'git@github.com:saicheems/discovery-artifact-manager.git')
    subprocess.call(shlex.split(cmd), cwd=dartman_dir)

    return 'Hello world!'


if __name__ == '__main__':
    app.run(host='127.0.0.1', port=8080, debug=True)

from subprocess import call
import json
import os

call(['./gradlew', 'discoJar'], cwd='toolkit')

call(['mkdir', '-p', 'discoveries'])

ddoc_file = 'discoveries/translate.v2.json'
ddoc_url = 'https://content.googleapis.com/discovery/v1/apis/translate/v2/rest'

call(['wget', '-O', ddoc_file, ddoc_url])

name, version, revision = '', '', ''
with open(ddoc_file) as file_:
    root = json.load(file_)
    name, version, revision = root['name'], root['version'], root['revision']

dir_ = 'autogenerated/{}/{}/{}'.format(name, version, revision)

if not os.path.exists(dir_):
    os.makedirs(dir_)

ovr_arg = ''
dv_ovr_path = '{}/translate.v2.override1.json'.format(dir_)
call(['python', 'gen_ovr.py', 'discoveries/translate.v2.json',
      '--output', dv_ovr_path])
ovr_arg += dv_ovr_path + ','

ovr_path = 'discoveries/translate.v2.override.json'
orig_ovr_path = '{}/translate.v2.override2.json'.format(dir_)
ovr_suffix = '2'
if os.path.isfile(ovr_path):
    call(['cp', ovr_path, orig_ovr_path])
    ovr_arg += orig_ovr_path + ','
    ovr_suffix = '3'

auth_ovr = {
  'csharp|go|java|js|nodejs|php|python|ruby': {
    'authType': 'NONE'
  },
  'js|python': {
    'discoveryDocUrl': 'http://localhost:5000/static/compute.v1.json'
  }
}
auth_ovr_path = '{}/translate.v2.override{}.json'.format(dir_, ovr_suffix)
with open(auth_ovr_path, 'w') as file_:
    file_.write(json.dumps(auth_ovr, sort_keys=True, indent=2))
    ovr_arg += auth_ovr_path

print ovr_arg

resources = 'toolkit/src/main/resources/com/google/api/codegen'
call(['java', '-jar', 'toolkit/build/libs/discoGen-0.0.5.jar',
      '--discovery_doc', 'discoveries/translate.v2.json',
      '--gapic_yaml',
      '{}/py/python_discovery.yaml'.format(resources),
      '--overrides', ovr_arg])

call(['python', 'gen_mocks.py', 'discoveries/translate.v2.json',
      '--directory', dir_])

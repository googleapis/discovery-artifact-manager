#!/bin/bash 

# COMPILECHECK_DIR where to run the compilecheck and write associated files
# COMPILECHECK_TOOLKIT
# COMPILECHECK_GAPICMDS
# COMPILECHECK_GOPATH
# COMPILECHECK_DISCOVERY

set -x

[[ "${BASH_SOURCE[0]}" != "${0}" ]] && { echo "Please execute this script rather than sourcing it!"; return; }

DATE="$(date '+%Y-%m-%d.%H%M%S')"
PARENT_DIR="${COMPILECHECK_DIR:-${TMPDIR:-/tmp}}/discogen-${DATE}"
COMPILECHECK_TOOLKIT="${COMPILECHECK_TOOLKIT:-${HOME}/gapi-dev/toolkit}"
COMPILECHECK_GAPICMDS="${COMPILECHECK_GAPICMDS:-${HOME}/gapi-dev/gapi-cmds}"
COMPILECHECK_GOPATH="${COMPILECHECK_GOPATH:-${GOPATH}}"
DISCOVERY_PATH="${COMPILECHECK_DISCOVERY:-${COMPILECHECK_TOOLKIT}}"
LANGUAGES="java php csharp nodejs ruby go py"
CHECK_SCRIPT="${PARENT_DIR}/checker"

function join_by { IFS="$1"; shift; echo "$*"; }
function terminate { echo "$0: Terminating ($1)" ; exit $1; }

echo <<EOF
$0:
Running compilecheck in $PARENT_DIR

  COMPILECHECK_TOOLKIT="${COMPILECHECK_TOOLKIT}"
 COMPILECHECK_GAPICMDS="${COMPILECHECK_GAPICMDS}"
        DISCOVERY_PATH="${DISCOVERY_PATH}"
   COMPILECHECK_GOPATH="${COMPILECHECK_GOPATH}"

EOF
 
export SNIPPET_DIR="${PARENT_DIR}/snippet"
mkdir -p "${SNIPPET_DIR}"
CHECK_DIR="${PARENT_DIR}/check"
mkdir -p "${CHECK_DIR}"
LIB_DIR="${PARENT_DIR}/lib"
mkdir -p "${LIB_DIR}"

LANGUAGE_YAMLS=$(echo -n "$LANGUAGES" | xargs -d " " -ILANG echo "${COMPILECHECK_TOOLKIT}/src/main/resources/com/google/api/codegen/LANG/LANG_discovery.yaml")
export GOPATH="${COMPILECHECK_GOPATH}"
CONCATENATED_YAMLS="$(join_by @ $(echo ${LANGUAGE_YAMLS} | sed s/py_discovery/python_discovery/))"
export ALL_YAMLS="$(join_by ' ' $(echo ${LANGUAGE_YAMLS} | sed s/py_discovery/python_discovery/))"

JAVA_YAML=${LANGUAGE_YAMLS[0]} # TESTING only

echo "$0: Generating snippets..."

pushd "${COMPILECHECK_TOOLKIT}"

# intended but not working: all the yamls get merged
# find "${DISCOVERY_PATH}" -type f | \
#   xargs -t -IFILE \
#   ./gradlew runDiscoGen "-Pclargs=--discovery_doc=FILE,--gapic_yaml=${CONCATENATED_YAMLS},--output=${SNIPPET_DIR}" || terminate $?


function allyamls() {
  local FILE="$1"
  echo -n ${ALL_YAMLS} | xargs -d " " -t -IYAMLF ./gradlew runDiscoGen "-Pclargs=--discovery_doc=${FILE},--gapic_yaml=YAMLF,--output=${SNIPPET_DIR}"  || terminate $?
}

export -f allyamls

find "${DISCOVERY_PATH}" -type f | xargs -t -IFILE bash -c 'allyamls $@' FILE

popd  #  "${COMPILECHECK_TOOLKIT}"

pushd "${COMPILECHECK_GAPICMDS}"

echo "$0: Running compilecheck binary (generating compilecheck snippets)"
#CHECK=$(go run ./src/snippetgen/compilecheck/compilecheck.go --tst "${CHECK_DIR}" --lib "${LIB_DIR}" "${SNIPPET_DIR}") || terminate $?
go run ./src/snippetgen/compilecheck/compilecheck.go --tst "${CHECK_DIR}" --lib "${LIB_DIR}" "${SNIPPET_DIR}" > ${CHECK_SCRIPT} || terminate $?

echo "$0: Compile-checking (running the generated compilecheck snippets)"
{ . ${CHECK_SCRIPT}; } || terminate $?

popd  # "${COMPILECHECK_GAPICMDS}"

echo "$0: Success."

 
